<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RouteNova | Smart Rural Logistics</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        #map { height: 300px; width: 100%; border-radius: 1.5rem; }
        .app-container { max-width: 480px; margin: 0 auto; min-height: 100vh; }
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); }
    </style>
</head>
<body class="bg-slate-100 font-sans antialiased text-slate-900">

    <div class="app-container bg-white shadow-2xl flex flex-col min-h-screen relative">
        
        <header class="p-6 flex justify-between items-center border-b bg-white sticky top-0 z-50">
            <div>
                <h1 class="text-2xl font-black text-green-600 italic tracking-tighter">RouteNova</h1>
                <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Rural Micro-Logistics</p>
            </div>
            <div id="status-pill" class="bg-green-100 text-green-700 text-[10px] px-3 py-1 rounded-full font-bold">DRIVER ONLINE</div>
        </header>

        <div class="flex p-2 bg-slate-100 m-4 rounded-2xl">
            <button onclick="switchView('driver')" id="tab-driver" class="flex-1 py-2 text-sm font-bold rounded-xl transition-all bg-white shadow-sm text-green-600">Driver View</button>
            <button onclick="switchView('shipper')" id="tab-shipper" class="flex-1 py-2 text-sm font-bold rounded-xl transition-all text-slate-500">Shipper View</button>
        </div>

        <main id="app-content" class="flex-1 p-4 pb-32">
            </main>

        <div id="action-bar" class="fixed bottom-0 left-0 right-0 max-w-[480px] mx-auto p-6 bg-gradient-to-t from-white via-white to-transparent">
            <button id="primary-btn" onclick="handlePrimaryAction()" class="w-full bg-green-600 hover:bg-green-700 text-white font-black py-4 rounded-2xl shadow-xl transition-all transform active:scale-95 flex justify-center items-center gap-2">
                ACCEPT ALL BUNDLES ($22)
            </button>
        </div>
    </div>

    <script>
        let currentRole = 'driver';
        let currentStep = 'matches'; // matches -> map -> qrcode
        let map = null;

        function switchView(role) {
            currentRole = role;
            currentStep = 'matches';
            const driverTab = document.getElementById('tab-driver');
            const shipperTab = document.getElementById('tab-shipper');
            const btn = document.getElementById('primary-btn');
            const status = document.getElementById('status-pill');

            if (role === 'driver') {
                driverTab.className = "flex-1 py-2 text-sm font-bold rounded-xl bg-white shadow-sm text-green-600";
                shipperTab.className = "flex-1 py-2 text-sm font-bold rounded-xl text-slate-500";
                status.innerText = "DRIVER ONLINE";
                status.className = "bg-green-100 text-green-700 text-[10px] px-3 py-1 rounded-full font-bold";
                btn.parentElement.style.display = "block";
                renderDriverMatches();
            } else {
                shipperTab.className = "flex-1 py-2 text-sm font-bold rounded-xl bg-white shadow-sm text-blue-600";
                driverTab.className = "flex-1 py-2 text-sm font-bold rounded-xl text-slate-500";
                status.innerText = "SHIPPER MODE";
                status.className = "bg-blue-100 text-blue-700 text-[10px] px-3 py-1 rounded-full font-bold";
                btn.parentElement.style.display = "none";
                renderShipperForm();
            }
        }

        function renderDriverMatches() {
    const content = document.getElementById('app-content');
    content.innerHTML = `
        <div class="animate-fade-in">
            <div class="bg-green-600 p-6 rounded-[2rem] shadow-xl mb-8 text-white">
                <h2 class="text-sm font-bold opacity-80 uppercase mb-4">Set Your Return Destination</h2>
                <div class="space-y-3">
                    <div class="relative">
                        <input type="text" id="destination-input" 
                               placeholder="Where are you heading?" 
                               class="w-full p-4 pl-12 rounded-2xl border-none text-slate-800 font-bold focus:ring-4 focus:ring-green-400 outline-none shadow-inner"
                               value="Green Valley Village">
                        <span class="absolute left-4 top-4 text-xl">üìç</span>
                    </div>
                    <button onclick="findLoadsOnRoute()" class="w-full bg-slate-900 text-white font-black py-4 rounded-2xl hover:bg-slate-800 transition-all flex justify-center items-center gap-2">
                        üîç FIND LOADS ON MY WAY
                    </button>
                </div>
            </div>

            <div id="results-container">
                <p class="text-center text-slate-400 text-sm italic mt-10 px-10">
                    Enter your destination above to see matches along your return path.
                </p>
            </div>
        </div>
    `;
    
    // Hide the primary button initially until they search
    document.getElementById('action-bar').style.display = "none";
}
// Mock Database of loads with specific coordinates
const MOCK_LOADS = [
    { id: 1, name: "4x Rice Sacks", pickup: "City Market Gate 4", lat: 12.9850, lng: 77.6050, pay: 15, weight: "40kg" },
    { id: 2, name: "Construction Tools", pickup: "Hardware Row", lat: 12.9600, lng: 77.5800, pay: 7, weight: "12kg" },
    { id: 3, name: "Organic Fertilizer", pickup: "Agri Depot", lat: 12.9900, lng: 77.6200, pay: 12, weight: "25kg" }
];


function renderShipperForm() {
    const content = document.getElementById('app-content');
    content.innerHTML = `
        <div class="animate-fade-in space-y-6">
            <div class="bg-white p-6 rounded-[2.5rem] shadow-xl border border-slate-100">
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <h2 class="text-lg font-black text-slate-800 tracking-tight">Active Tracking</h2>
                        <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mt-1">Order #RN-9921 ‚Ä¢ 4x Rice Sacks</p>
                    </div>
                    <span class="bg-blue-100 text-blue-600 text-[10px] px-3 py-1 rounded-full font-black animate-pulse">LIVE</span>
                </div>

                <div id="shipper-map" class="h-48 w-full rounded-3xl bg-slate-100 mb-6 shadow-inner"></div>

                <div class="relative flex justify-between items-center px-2">
                    <div class="absolute h-0.5 bg-slate-100 w-full top-3 -z-10"></div>
                    <div class="absolute h-0.5 bg-blue-500 w-2/3 top-3 -z-10 transition-all"></div>
                    
                    <div class="flex flex-col items-center gap-2">
                        <div class="h-6 w-6 bg-blue-600 rounded-full border-4 border-white shadow-sm"></div>
                        <span class="text-[8px] font-black text-slate-400">PICKUP</span>
                    </div>
                    <div class="flex flex-col items-center gap-2">
                        <div class="h-6 w-6 bg-blue-600 rounded-full border-4 border-white shadow-sm"></div>
                        <span class="text-[8px] font-black text-blue-600">IN TRANSIT</span>
                    </div>
                    <div class="flex flex-col items-center gap-2">
                        <div class="h-6 w-6 bg-white border-2 border-slate-200 rounded-full shadow-sm"></div>
                        <span class="text-[8px] font-black text-slate-400">VILLAGE</span>
                    </div>
                </div>

                <div class="mt-6 pt-6 border-t border-slate-50 flex justify-between items-center">
                    <div>
                        <p class="text-[10px] text-slate-400 font-bold uppercase">Estimated Delivery</p>
                        <p class="font-black text-slate-700">~ 42 minutes</p>
                    </div>
                    <button class="bg-slate-900 text-white text-[10px] font-bold px-4 py-2 rounded-xl">MESSAGE DRIVER</button>
                </div>
            </div>

            <button class="w-full py-4 bg-slate-100 border-2 border-dashed border-slate-200 rounded-3xl text-slate-500 font-bold flex items-center justify-center gap-2 hover:bg-white transition-all">
                <span>+</span> Post New Backhaul Request
            </button>
        </div>
    `;

    // Initialize the Tracking Map for the Shipper
    setTimeout(() => {
        const sMap = L.map('shipper-map', { zoomControl: false }).setView([12.9750, 77.5980], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(sMap);
        
        // Driver's moving icon (In a real app, this updates via Websockets/Firebase)
        const driverIcon = L.divIcon({
            className: 'bg-blue-600 w-4 h-4 rounded-full border-2 border-white shadow-lg shadow-blue-200',
            iconSize: [16, 16]
        });

        L.marker([12.9750, 77.5980], { icon: driverIcon }).addTo(sMap).bindPopup('Driver is moving').openPopup();
        L.marker([13.0500, 77.7500]).addTo(sMap); // Destination Village
    }, 200);
}
        function handlePrimaryAction() {
            if (currentStep === 'matches') {
                showRouteMap();
            } else if (currentStep === 'map') {
                showVerificationQR();
            }
        }
let selectedBundles = [];

function findLoadsOnRoute() {
    const dest = document.getElementById('destination-input').value;
    const results = document.getElementById('results-container');
    const actionBar = document.getElementById('action-bar');
    selectedBundles = []; // Reset selections
    
    results.innerHTML = `<div class="flex flex-col items-center mt-10"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-green-600"></div></div>`;

    setTimeout(() => {
        results.innerHTML = `<h3 class="text-sm font-bold text-slate-400 mb-4 uppercase tracking-widest px-2">Available for Micropooling</h3>`;
        
        MOCK_LOADS.forEach(load => {
            const extraDist = (Math.random() * 2.5).toFixed(1);
            results.innerHTML += `
                <div id="load-${load.id}" onclick="toggleBundle(${load.id}, ${load.pay})" class="bg-white p-5 rounded-3xl border-2 border-slate-50 shadow-sm cursor-pointer transition-all mb-4 relative overflow-hidden">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h3 class="font-black text-slate-800 text-lg">${load.name}</h3>
                            <p class="text-[11px] text-slate-400 font-medium">üìç ${load.pickup}</p>
                            <p class="text-[10px] text-orange-500 font-bold mt-2">+${extraDist} km deviation</p>
                        </div>
                        <div class="text-right">
                            <span class="text-2xl font-black text-green-600">$${load.pay}</span>
                            <div class="select-indicator mt-2 h-6 w-6 border-2 border-slate-200 rounded-full ml-auto"></div>
                        </div>
                    </div>
                </div>
            `;
        });
        actionBar.style.display = "block";
        updatePrimaryButton();
    }, 800);
}

function toggleBundle(id, pay) {
    const element = document.getElementById(`load-${id}`);
    const index = selectedBundles.indexOf(id);
    
    if (index > -1) {
        selectedBundles.splice(index, 1);
        element.classList.remove('border-green-500', 'bg-green-50');
    } else {
        selectedBundles.push(id);
        element.classList.add('border-green-500', 'bg-green-50');
    }
    updatePrimaryButton();
}

function updatePrimaryButton() {
    const btn = document.getElementById('primary-btn');
    if (selectedBundles.length === 0) {
        btn.innerText = "SELECT BUNDLES";
        btn.disabled = true;
        btn.classList.add('opacity-50');
    } else {
        btn.disabled = false;
        btn.classList.remove('opacity-50');
        const total = selectedBundles.length * 12; // Simple math for demo
        btn.innerText = `ACCEPT ${selectedBundles.length} BUNDLES ($${total})`;
    }
}

// Optimized Map Logic for Micropooling
function showRouteMap() {
    currentStep = 'map';
    const content = document.getElementById('app-content');
    content.innerHTML = `
        <h2 class="text-lg font-bold mb-4">Optimized Collection Route</h2>
        <div id="map" class="shadow-xl"></div>
        <div class="mt-4 grid grid-cols-2 gap-3">
            <div class="bg-white p-4 rounded-2xl border border-slate-100">
                <p class="text-[10px] text-slate-400 font-bold uppercase">Total Distance</p>
                <p class="text-lg font-black italic">14.2 km</p>
            </div>
            <div class="bg-white p-4 rounded-2xl border border-slate-100">
                <p class="text-[10px] text-slate-400 font-bold uppercase">Time Efficiency</p>
                <p class="text-lg font-black text-green-600 italic">+88%</p>
            </div>
        </div>
    `;
    
    setTimeout(() => {
        map = L.map('map').setView([12.9716, 77.5946], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        
        // SHOWING MULTIPLE STOPS (Route Optimization Visual)
        const stops = [
            [12.9716, 77.5946], // Current
            [12.9850, 77.6050], // Pickup 1
            [12.9900, 77.6200], // Pickup 2
            [13.0500, 77.7500]  // Home
        ];
        
        stops.forEach((stop, i) => {
            L.marker(stop).addTo(map).bindPopup(i === 0 ? "You" : i === 3 ? "Home" : "Pickup " + i);
        });

        L.polyline(stops, {color: '#16a34a', weight: 5, dashArray: '10, 10'}).addTo(map);
    }, 100);

    document.getElementById('primary-btn').innerText = "ARRIVED AT FINAL PICKUP";
}

        function showVerificationQR() {
            currentStep = 'qrcode';
            const content = document.getElementById('app-content');
            content.innerHTML = `
                <div class="flex flex-col items-center justify-center pt-10">
                    <div id="qrcode" class="p-6 bg-white rounded-[2.5rem] shadow-2xl border-8 border-green-50"></div>
                    <div class="mt-8 text-center">
                        <p class="font-black text-2xl text-slate-800 italic">VERIFY DELIVERY</p>
                        <p class="text-slate-400 text-sm font-medium mt-1">Scan at Green Valley Village Store</p>
                    </div>
                    <div class="mt-8 w-full bg-green-50 p-6 rounded-3xl border border-green-100">
                        <div class="flex justify-between items-center text-green-800 font-bold">
                            <span>CO2 REDUCED</span>
                            <span>4.8 kg</span>
                        </div>
                    </div>
                </div>
            `;
            
            new QRCode(document.getElementById("qrcode"), {
                text: "ROUTENOVA_ORDER_9921",
                width: 200,
                height: 200,
                colorDark : "#16a34a",
                colorLight : "#ffffff"
            });
            
            document.getElementById('action-bar').style.display = "none";
        }

        // Initialize App
        window.onload = renderDriverMatches;
    </script>
</body>
</html>