<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RouteNova | Smart Rural Logistics</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        @keyframes progress {
    0% { width: 0%; }
    100% { width: 100%; }
}
.animate-progress-fill {
    animation: progress 3s ease-in-out forwards;
}
        #map { height: 300px; width: 100%; border-radius: 1.5rem; }
        .app-container { max-width: 480px; margin: 0 auto; min-height: 100vh; }
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); }
    </style>
</head>
<body class="bg-slate-100 font-sans antialiased text-slate-900">

    <div class="app-container bg-white shadow-2xl flex flex-col min-h-screen relative">
        
        <header class="p-6 flex justify-between items-center border-b bg-white sticky top-0 z-50">
            <div>
                <h1 class="text-2xl font-black text-green-600 italic tracking-tighter">RouteNova</h1>
                <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Rural Micro-Logistics</p>
            </div>
            <div id="status-pill" class="bg-green-100 text-green-700 text-[10px] px-3 py-1 rounded-full font-bold">DRIVER ONLINE</div>
        </header>

        <div class="flex p-2 bg-slate-100 m-4 rounded-2xl">
            <button onclick="switchView('driver')" id="tab-driver" class="flex-1 py-2 text-sm font-bold rounded-xl transition-all bg-white shadow-sm text-green-600">Driver View</button>
            <button onclick="switchView('shipper')" id="tab-shipper" class="flex-1 py-2 text-sm font-bold rounded-xl transition-all text-slate-500">Shipper View</button>
        </div>

        <main id="app-content" class="flex-1 p-4 pb-32">
            </main>

        <div id="action-bar" class="fixed bottom-0 left-0 right-0 max-w-[480px] mx-auto p-6 bg-gradient-to-t from-white via-white to-transparent">
            <button id="primary-btn" onclick="handlePrimaryAction()" class="w-full bg-green-600 hover:bg-green-700 text-white font-black py-4 rounded-2xl shadow-xl transition-all transform active:scale-95 flex justify-center items-center gap-2">
                ACCEPT ALL BUNDLES ($22)
            </button>
        </div>
    </div>
<script>
    // --- GLOBAL STATE ---
    let escrowBalance = 0;
    let driverEarnings = 0;
    const BUNDLE_VALUE = 22; 
    let currentRole = null; 
    let currentStep = 'matches'; 
    let userProfile = { name: null, role: null, phone: null, vehicle: null, capacity: null };
    let map = null;

    // --- 1. DYNAMIC PROFILE CREATION ---
    function renderProfileSetup() {
        const content = document.getElementById('app-content');
        document.getElementById('action-bar').style.display = "none";
        document.querySelector('.flex.p-2.bg-slate-100').style.display = "none"; // Hide tabs

        content.innerHTML = `
            <div class="animate-fade-in p-2">
                <div class="mb-8">
                    <h2 class="text-3xl font-black text-slate-900 tracking-tighter italic">RouteNova Setup</h2>
                    <p class="text-slate-400 text-sm">Choose your account type to verify.</p>
                </div>

                <div class="grid grid-cols-1 gap-4 mb-6">
                    <div onclick="selectRole('driver')" id="role-driver" class="p-6 bg-white border-2 border-slate-100 rounded-[2.5rem] cursor-pointer transition-all hover:border-green-500">
                        <div class="flex justify-between items-center">
                            <div><h3 class="font-black text-xl">Driver</h3><p class="text-[10px] text-slate-400 font-bold">Earn from empty space</p></div>
                            <span class="text-3xl">üöö</span>
                        </div>
                    </div>
                    <div onclick="selectRole('shipper')" id="role-shipper" class="p-6 bg-white border-2 border-slate-100 rounded-[2.5rem] cursor-pointer transition-all hover:border-blue-500">
                        <div class="flex justify-between items-center">
                            <div><h3 class="font-black text-xl">Shipper</h3><p class="text-[10px] text-slate-400 font-bold">Secure rural delivery</p></div>
                            <span class="text-3xl">üì¶</span>
                        </div>
                    </div>
                </div>

                <div id="registration-form" class="hidden space-y-4 bg-slate-50 p-6 rounded-[2.5rem] border border-slate-200">
                    <div class="space-y-3">
                        <input type="text" id="reg-name" placeholder="Full Name" class="w-full p-4 rounded-2xl border-none font-bold outline-none shadow-sm">
                        <input type="tel" id="reg-phone" placeholder="Phone Number" class="w-full p-4 rounded-2xl border-none font-bold outline-none shadow-sm">
                        
                        <div id="driver-only" class="hidden space-y-3">
                            <div class="flex gap-2">
                                <input type="text" id="reg-vehicle" placeholder="Vehicle (e.g. Pickup)" class="w-1/2 p-4 rounded-2xl border-none font-bold outline-none shadow-sm text-sm">
                                <input type="text" id="reg-cap" placeholder="Cap (kg)" class="w-1/2 p-4 rounded-2xl border-none font-bold outline-none shadow-sm text-sm">
                            </div>
                            <div class="p-4 bg-white rounded-2xl border-2 border-dashed border-green-200 text-center">
                                <p class="text-[9px] font-black text-green-600 uppercase mb-2">Required: Driving License</p>
                                <input type="file" id="driver-id" class="hidden" onchange="updateFileLabel('driver-id-label')">
                                <button onclick="document.getElementById('driver-id').click()" id="driver-id-label" class="text-[10px] font-bold bg-slate-100 px-4 py-2 rounded-lg">Upload Photo</button>
                            </div>
                        </div>

                        <div id="shipper-only" class="hidden space-y-3">
                            <input type="text" id="reg-prof" placeholder="Business / Profession" class="w-full p-4 rounded-2xl border-none font-bold outline-none shadow-sm">
                            <div class="p-4 bg-white rounded-2xl border-2 border-dashed border-blue-200 text-center">
                                <p class="text-[9px] font-black text-blue-600 uppercase mb-2">Required: Aadhar / Gov ID</p>
                                <input type="file" id="shipper-id" class="hidden" onchange="updateFileLabel('shipper-id-label')">
                                <button onclick="document.getElementById('shipper-id').click()" id="shipper-id-label" class="text-[10px] font-bold bg-slate-100 px-4 py-2 rounded-lg">Upload Proof</button>
                            </div>
                        </div>
                    </div>
                    <button onclick="startVerification()" class="w-full bg-slate-900 text-white font-black py-5 rounded-[2rem] shadow-xl mt-4">VERIFY IDENTITY</button>
                </div>
            </div>
        `;
    }

    function selectRole(role) {
        currentRole = role;
        document.getElementById('registration-form').classList.remove('hidden');
        document.getElementById('driver-only').classList.toggle('hidden', role !== 'driver');
        document.getElementById('shipper-only').classList.toggle('hidden', role !== 'shipper');
        
        // Highlight active card
        document.getElementById('role-driver').style.borderColor = role === 'driver' ? '#16a34a' : '#f1f5f9';
        document.getElementById('role-shipper').style.borderColor = role === 'shipper' ? '#2563eb' : '#f1f5f9';
    }

    function updateFileLabel(id) {
        document.getElementById(id).innerText = "File Attached ‚úÖ";
        document.getElementById(id).classList.add('text-green-600');
    }

    // --- 2. AI VERIFICATION ANIMATION ---
    function startVerification() {
        const name = document.getElementById('reg-name').value;
        if(!name) return alert("Fill out the profile!");

        const content = document.getElementById('app-content');
        content.innerHTML = `
            <div class="flex flex-col items-center justify-center min-h-[500px] text-center p-8">
                <div class="relative w-24 h-24 mb-10">
                    <div class="absolute inset-0 border-8 border-slate-100 rounded-full"></div>
                    <div class="absolute inset-0 border-8 border-${currentRole === 'driver' ? 'green' : 'blue'}-600 rounded-full border-t-transparent animate-spin"></div>
                </div>
                <h2 class="text-2xl font-black italic uppercase">AI Verifying...</h2>
                <p class="text-[10px] text-slate-400 font-bold mt-4 tracking-widest px-10">Cross-referencing National Database & ID Authentication</p>
                <div class="mt-10 w-48 bg-slate-100 h-1.5 rounded-full overflow-hidden">
                    <div class="bg-${currentRole === 'driver' ? 'green' : 'blue'}-600 h-full animate-progress-fill"></div>
                </div>
            </div>
        `;

        setTimeout(() => {
            userProfile.role = currentRole;
            document.querySelector('.flex.p-2.bg-slate-100').style.display = "flex";
            switchView(currentRole);
        }, 3500);
    }

    // --- 3. SYSTEM NAVIGATION ---
    function switchView(role) {
        if(userProfile.role && role !== userProfile.role) {
            alert(`You are a verified ${userProfile.role}. Access Denied.`);
            return;
        }
        currentRole = role;
        role === 'driver' ? renderDriverMatches() : renderShipperForm();
    }

    function renderDriverMatches() {
        const content = document.getElementById('app-content');
        content.innerHTML = `
            <div class="animate-fade-in">
                <div class="bg-green-600 p-6 rounded-[2rem] text-white mb-6">
                    <p class="text-[10px] font-bold opacity-70 uppercase mb-2">Set Destination</p>
                    <input type="text" id="dest" value="Green Valley Village" class="w-full p-4 rounded-2xl text-slate-900 font-bold outline-none mb-3">
                    <button onclick="findLoads()" class="w-full bg-slate-900 py-4 rounded-2xl font-black text-xs">FIND LOADS ON ROUTE</button>
                </div>
                <div id="results"></div>
            </div>`;
        document.getElementById('action-bar').style.display = "none";
    }

    function findLoads() {
        document.getElementById('results').innerHTML = `
            <div class="p-4 bg-white rounded-3xl border-2 border-green-500 mb-4" onclick="document.getElementById('action-bar').style.display='block'">
                <div class="flex justify-between">
                    <div><h3 class="font-black">4x Rice Sacks</h3><p class="text-[10px] text-slate-400">Hub 4 üìç</p></div>
                    <p class="text-xl font-black text-green-600">$22</p>
                </div>
            </div>`;
    }

    function handlePrimaryAction() {
        if(currentStep === 'matches') showRouteMap();
        else if(currentStep === 'map') showVerificationQR();
    }

    // --- 4. MAPS & ESCROW FLOW ---
    function showRouteMap() {
        currentStep = 'map';
        const content = document.getElementById('app-content');
        content.innerHTML = `
            <div class="animate-fade-in">
                <div id="map" style="height: 350px;" class="rounded-[2rem] mb-6 shadow-xl border-4 border-white"></div>
                <div class="bg-slate-900 text-white p-6 rounded-[2.5rem] shadow-2xl">
                    <p class="text-[10px] font-bold text-green-400 uppercase tracking-widest mb-4 text-center">üîê Escrow Pending Pickup</p>
                    <button onclick="document.getElementById('cam-1').click()" class="w-full py-4 bg-white text-slate-900 rounded-2xl font-black text-xs">CAPTURE PICKUP</button>
                    <input type="file" id="cam-1" capture="camera" class="hidden" onchange="previewPickup(this)">
                </div>
            </div>`;
        initMap();
        document.getElementById('primary-btn').innerText = "ARRIVED AT UNLOAD";
    }

    function initMap() {
        map = L.map('map').setView([12.9716, 77.5946], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        L.marker([12.9716, 77.5946]).addTo(map).bindPopup("Current Position").openPopup();
        L.polyline([[12.9716, 77.5946], [12.8500, 77.6500]], {color: '#16a34a', weight: 6}).addTo(map);
    }

   // --- UPDATED FLOW: STEP 2 (DELIVERY VERIFICATION) ---

function showVerificationQR() {
    currentStep = 'qrcode';
    const content = document.getElementById('app-content');
    
    // We start with the QR hidden and the 'Unload Photo' required
    content.innerHTML = `
        <div class="flex flex-col items-center pt-4 animate-fade-in">
            <h2 class="text-xs font-black text-slate-400 uppercase tracking-widest mb-6 italic">Step 2: Delivery Verification</h2>
            
            <div id="pod-card" class="bg-white p-6 rounded-[2.5rem] shadow-xl border-2 border-blue-100 mb-6 w-full transition-all">
                <div class="flex items-center gap-3 mb-4">
                    <div class="h-8 w-8 bg-blue-50 rounded-full flex items-center justify-center text-sm">üì∏</div>
                    <p class="text-sm font-black text-slate-700">Proof of Unloading</p>
                </div>
                
                <div id="photo-preview-unload" class="w-full h-44 bg-slate-50 rounded-3xl mb-4 border-2 border-dashed border-slate-200 flex flex-col items-center justify-center overflow-hidden">
                     <span class="text-slate-300 text-[10px] font-bold uppercase tracking-widest">Awaiting Photo...</span>
                </div>

                <input type="file" id="camera-unload" accept="image/*" capture="camera" class="hidden" onchange="previewUnload(this)">
                
                <button id="unload-btn" onclick="document.getElementById('camera-unload').click()" class="w-full py-4 bg-blue-600 text-white font-black rounded-2xl shadow-lg shadow-blue-200 uppercase text-[10px] tracking-widest transition-all active:scale-95">
                    CAPTURE UNPACKED GOODS
                </button>
            </div>

            <div id="qr-container" class="hidden flex flex-col items-center animate-fade-in">
                <div class="bg-green-500 text-white text-[9px] font-black px-4 py-1.5 rounded-full mb-4 shadow-lg animate-bounce">
                    ‚úÖ UNLOAD VERIFIED - SHOW TO RECEIVER
                </div>
                <div onclick="completePayment()" class="cursor-pointer p-6 bg-white rounded-[2.5rem] shadow-2xl border-8 border-green-50">
                    <div id="qrcode"></div>
                </div>
                <p class="mt-4 text-[10px] font-black text-slate-400 uppercase italic">Receiver scans to release $${escrowBalance}.00</p>
            </div>
        </div>
    `;
    
    // Generate the QR in the background, but it stays hidden
    new QRCode(document.getElementById("qrcode"), {
        text: "POD_VERIFIED_RELEASE_FUNDS",
        width: 160,
        height: 160,
        colorDark : "#0f172a",
        colorLight : "#ffffff"
    });
    
    document.getElementById('action-bar').style.display = "none";
}

// Logic to handle the Unload Photo
function previewUnload(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            // Show the photo
            const container = document.getElementById('photo-preview-unload');
            container.innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover animate-fade-in">`;
            
            // UI Transition: Dim the photo card and show the QR
            document.getElementById('pod-card').style.opacity = "0.5";
            document.getElementById('unload-btn').innerText = "PHOTO UPLOADED ‚úÖ";
            document.getElementById('unload-btn').disabled = true;
            
            // Show the QR Code for the receiver
            document.getElementById('qr-container').classList.remove('hidden');
            
            // Add to offline sync queue (for rural reliability)
            console.log("PoD Saved: Proof of delivery stored for Shipper audit.");
        };
        reader.readAsDataURL(input.files[0]);
    }
}
    

    function completePayment() {
        document.getElementById('app-content').innerHTML = `
            <div class="p-10 text-center animate-fade-in">
                <div class="h-24 w-24 bg-green-500 rounded-full flex items-center justify-center mx-auto text-5xl mb-8 shadow-2xl animate-bounce">üí∞</div>
                <h1 class="text-4xl font-black italic tracking-tighter">PAID $22.00</h1>
                <p class="text-slate-400 font-bold mt-4 uppercase text-[10px]">Successfully Transferred to Wallet</p>
                <button onclick="location.reload()" class="mt-16 text-xs font-black border-b-2 border-slate-900 pb-1">FINISH DEMO</button>
            </div>`;
    }

    function renderShipperForm() {
        document.getElementById('app-content').innerHTML = `
            <div class="bg-blue-600 p-8 rounded-[3rem] text-white animate-fade-in">
                <h2 class="text-2xl font-black italic mb-4">Shipper Tracking</h2>
                <div class="bg-white/10 p-4 rounded-2xl border border-white/20">
                    <p class="text-[9px] uppercase font-bold tracking-widest opacity-60">Professional Account Verified</p>
                    <p class="text-lg font-bold">${userProfile.name}</p>
                </div>
                <p class="mt-8 text-xs font-medium">Monitoring rural distribution channels...</p>
            </div>`;
    }

    window.onload = renderProfileSetup;
</script>
</body>
</html>