<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RouteNova | Smart Rural Logistics</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        #map { height: 300px; width: 100%; border-radius: 1.5rem; }
        .app-container { max-width: 480px; margin: 0 auto; min-height: 100vh; }
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); }
    </style>
</head>
<body class="bg-slate-100 font-sans antialiased text-slate-900">

    <div class="app-container bg-white shadow-2xl flex flex-col min-h-screen relative">
        
        <header class="p-6 flex justify-between items-center border-b bg-white sticky top-0 z-50">
            <div>
                <h1 class="text-2xl font-black text-green-600 italic tracking-tighter">RouteNova</h1>
                <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Rural Micro-Logistics</p>
            </div>
            <div id="status-pill" class="bg-green-100 text-green-700 text-[10px] px-3 py-1 rounded-full font-bold">DRIVER ONLINE</div>
        </header>

        <div class="flex p-2 bg-slate-100 m-4 rounded-2xl">
            <button onclick="switchView('driver')" id="tab-driver" class="flex-1 py-2 text-sm font-bold rounded-xl transition-all bg-white shadow-sm text-green-600">Driver View</button>
            <button onclick="switchView('shipper')" id="tab-shipper" class="flex-1 py-2 text-sm font-bold rounded-xl transition-all text-slate-500">Shipper View</button>
        </div>

        <main id="app-content" class="flex-1 p-4 pb-32">
            </main>

        <div id="action-bar" class="fixed bottom-0 left-0 right-0 max-w-[480px] mx-auto p-6 bg-gradient-to-t from-white via-white to-transparent">
            <button id="primary-btn" onclick="handlePrimaryAction()" class="w-full bg-green-600 hover:bg-green-700 text-white font-black py-4 rounded-2xl shadow-xl transition-all transform active:scale-95 flex justify-center items-center gap-2">
                ACCEPT ALL BUNDLES ($22)
            </button>
        </div>
    </div>

    <script>
        let currentRole = 'driver';
        let currentStep = 'matches'; // matches -> map -> qrcode
        let map = null;

        function switchView(role) {
            currentRole = role;
            currentStep = 'matches';
            const driverTab = document.getElementById('tab-driver');
            const shipperTab = document.getElementById('tab-shipper');
            const btn = document.getElementById('primary-btn');
            const status = document.getElementById('status-pill');

            if (role === 'driver') {
                driverTab.className = "flex-1 py-2 text-sm font-bold rounded-xl bg-white shadow-sm text-green-600";
                shipperTab.className = "flex-1 py-2 text-sm font-bold rounded-xl text-slate-500";
                status.innerText = "DRIVER ONLINE";
                status.className = "bg-green-100 text-green-700 text-[10px] px-3 py-1 rounded-full font-bold";
                btn.parentElement.style.display = "block";
                renderDriverMatches();
            } else {
                shipperTab.className = "flex-1 py-2 text-sm font-bold rounded-xl bg-white shadow-sm text-blue-600";
                driverTab.className = "flex-1 py-2 text-sm font-bold rounded-xl text-slate-500";
                status.innerText = "SHIPPER MODE";
                status.className = "bg-blue-100 text-blue-700 text-[10px] px-3 py-1 rounded-full font-bold";
                btn.parentElement.style.display = "none";
                renderShipperForm();
            }
        }

        function renderDriverMatches() {
    const content = document.getElementById('app-content');
    content.innerHTML = `
        <div class="animate-fade-in">
            <div class="bg-green-600 p-6 rounded-[2rem] shadow-xl mb-8 text-white">
                <h2 class="text-sm font-bold opacity-80 uppercase mb-4">Set Your Return Destination</h2>
                <div class="space-y-3">
                    <div class="relative">
                        <input type="text" id="destination-input" 
                               placeholder="Where are you heading?" 
                               class="w-full p-4 pl-12 rounded-2xl border-none text-slate-800 font-bold focus:ring-4 focus:ring-green-400 outline-none shadow-inner"
                               value="Green Valley Village">
                        <span class="absolute left-4 top-4 text-xl">üìç</span>
                    </div>
                    <button onclick="findLoadsOnRoute()" class="w-full bg-slate-900 text-white font-black py-4 rounded-2xl hover:bg-slate-800 transition-all flex justify-center items-center gap-2">
                        üîç FIND LOADS ON MY WAY
                    </button>
                </div>
            </div>

            <div id="results-container">
                <p class="text-center text-slate-400 text-sm italic mt-10 px-10">
                    Enter your destination above to see matches along your return path.
                </p>
            </div>
        </div>
    `;
    
    // Hide the primary button initially until they search
    document.getElementById('action-bar').style.display = "none";
}

function findLoadsOnRoute() {
    const dest = document.getElementById('destination-input').value;
    const results = document.getElementById('results-container');
    const actionBar = document.getElementById('action-bar');
    
    // Show loading state
    results.innerHTML = `<div class="flex flex-col items-center mt-10"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-green-600"></div><p class="text-xs text-slate-400 mt-2">Calculating route to ${dest}...</p></div>`;

    setTimeout(() => {
        results.innerHTML = `
            <h3 class="text-sm font-bold text-slate-400 mb-4 uppercase tracking-widest px-2">Top Matches Near Your Route</h3>
            <div class="space-y-4">
                <div class="bg-white p-5 rounded-3xl border-2 border-green-100 shadow-sm relative overflow-hidden">
                    <div class="absolute top-0 right-0 bg-green-500 text-white text-[8px] font-black px-3 py-1 rounded-bl-xl uppercase tracking-widest">98% Match</div>
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="font-black text-slate-800">4x Rice Sacks</h3>
                            <p class="text-[10px] text-slate-400 font-bold uppercase mt-1">Pickup: City Market (0.5km away)</p>
                            <p class="text-[10px] text-blue-500 font-bold uppercase mt-1 italic">Dropoff: On your route to ${dest}</p>
                        </div>
                        <span class="text-xl font-black text-green-600">$15</span>
                    </div>
                </div>

                <div class="bg-white p-5 rounded-3xl border border-slate-100 shadow-sm opacity-80">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="font-black text-slate-800 text-sm">Hardware Tools</h3>
                            <p class="text-[10px] text-slate-400 font-bold uppercase mt-1">Pickup: 2km deviation</p>
                        </div>
                        <span class="text-lg font-black text-green-600">$7</span>
                    </div>
                </div>
            </div>
        `;
        
        // Show the Accept button now that results are found
        actionBar.style.display = "block";
        document.getElementById('primary-btn').innerText = `ACCEPT ${dest} BUNDLE ($22)`;
    }, 1200);
}

        function renderShipperForm() {
            const content = document.getElementById('app-content');
            content.innerHTML = `
                <div class="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm">
                    <h2 class="text-lg font-bold mb-4">Post a Backhaul Request</h2>
                    <div class="space-y-4">
                        <div>
                            <label class="text-[10px] font-bold text-slate-400 uppercase ml-2">Item Name</label>
                            <input type="text" placeholder="e.g. Fertilizer Sacks" class="w-full p-4 bg-slate-50 rounded-2xl border-none focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-slate-400 uppercase ml-2">Total Weight (kg)</label>
                            <input type="number" placeholder="50" class="w-full p-4 bg-slate-50 rounded-2xl border-none focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                        <button class="w-full bg-blue-600 text-white font-bold py-4 rounded-2xl shadow-lg shadow-blue-100">FIND A RETURNING TRUCK</button>
                    </div>
                </div>
            `;
        }

        function handlePrimaryAction() {
            if (currentStep === 'matches') {
                showRouteMap();
            } else if (currentStep === 'map') {
                showVerificationQR();
            }
        }

        function showRouteMap() {
            currentStep = 'map';
            const content = document.getElementById('app-content');
            content.innerHTML = `
                <h2 class="text-lg font-bold mb-4">Route to Pickup</h2>
                <div id="map" class="shadow-xl"></div>
                <div class="mt-6 p-5 bg-white rounded-3xl border border-slate-100 shadow-sm flex items-center gap-4">
                    <div class="h-12 w-12 bg-green-100 rounded-full flex items-center justify-center text-green-600 font-bold">12m</div>
                    <div>
                        <p class="text-xs font-bold text-slate-400">NEXT STOP</p>
                        <p class="font-black">City Market Gate 4</p>
                    </div>
                </div>
            `;
            
            // Map logic
            setTimeout(() => {
                map = L.map('map').setView([12.9716, 77.5946], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                L.marker([12.9716, 77.5946]).addTo(map).bindPopup('You');
                L.marker([12.9850, 77.6050]).addTo(map).bindPopup('Pickup');
                L.polyline([[12.9716, 77.5946], [12.9850, 77.6050]], {color: '#16a34a', weight: 6}).addTo(map);
            }, 100);

            document.getElementById('primary-btn').innerText = "I HAVE ARRIVED AT PICKUP";
        }

        function showVerificationQR() {
            currentStep = 'qrcode';
            const content = document.getElementById('app-content');
            content.innerHTML = `
                <div class="flex flex-col items-center justify-center pt-10">
                    <div id="qrcode" class="p-6 bg-white rounded-[2.5rem] shadow-2xl border-8 border-green-50"></div>
                    <div class="mt-8 text-center">
                        <p class="font-black text-2xl text-slate-800 italic">VERIFY DELIVERY</p>
                        <p class="text-slate-400 text-sm font-medium mt-1">Scan at Green Valley Village Store</p>
                    </div>
                    <div class="mt-8 w-full bg-green-50 p-6 rounded-3xl border border-green-100">
                        <div class="flex justify-between items-center text-green-800 font-bold">
                            <span>CO2 REDUCED</span>
                            <span>4.8 kg</span>
                        </div>
                    </div>
                </div>
            `;
            
            new QRCode(document.getElementById("qrcode"), {
                text: "ROUTENOVA_ORDER_9921",
                width: 200,
                height: 200,
                colorDark : "#16a34a",
                colorLight : "#ffffff"
            });
            
            document.getElementById('action-bar').style.display = "none";
        }

        // Initialize App
        window.onload = renderDriverMatches;
    </script>
</body>
</html>